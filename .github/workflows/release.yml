name: Build and Release Student Planner

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' # Dispara automaticamente se você enviar uma tag (ex: git push origin v1.0)

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Configurar Cache do Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Dar permissão de execução ao Gradle
        run: chmod +x ./gradlew

      - name: Construir o APK de Release
        run: ./gradlew assembleRelease -PversionCode=${{ github.run_number }} -PversionName="1.0.${{ github.run_number }}"
        
      - name: Assinar o APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        env:
          BUILD_TOOLS_VERSION: "34.0.0"
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.KEYSTORE_BASE64 }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Renomear o arquivo APK Assinado
        run: |
          # A action de assinatura exporta a variável com o caminho do APK final assinado
          mv ${{steps.sign_app.outputs.signedReleaseFile}} StudentPlanner-v1.0.${{ github.run_number }}.apk

      - name: Publicar no GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: "Student Planner Release v1.0.${{ github.run_number }}"
          files: StudentPlanner-v1.0.${{ github.run_number }}.apk
          generate_release_notes: true
